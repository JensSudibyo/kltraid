<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>Video Player</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.1.1/controls.min.css" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: black;
        }
        .shaka-video-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            height: 100%;
        }
        .shaka-video {
            width: 100%;
            height: 100%;
        }
        .shaka-play-button,
        .shaka-spinner-container {
            transform: scale(0.8);
        }
        .shaka-video-container .material-icons-round {
            color: #f1ff00;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.1.1/shaka-player.ui.min.js" crossorigin="anonymous"></script>
</head>
<body>
    <center>
        <div data-shaka-player-container style="width: 100%; height: 100%; cursor: none;" shaka-controls="true" class="shaka-video-container">
            <video autoplay data-shaka-player id="video" style="width:100%;height:100%;" class="shaka-video" poster="/images/poster.png"></video>
            <div class="shaka-controls-container"></div>
        </div>
    </center>

    <script type="module">
        import channels from './channel.js';

        // Konfigurasi Player
        const allowedDomains = ['https://kltraid.pages.dev', 'https://bikinbaru96.blogspot.com', 'http://localhost'];
        let player, ui, controls;
        let isPlayerReady = false;
        const pendingMessages = [];

        // Fungsi Validasi Origin
        function validateOrigin(origin) {
            try {
                const originUrl = new URL(origin);
                return allowedDomains.some(allowed => {
                    const allowedUrl = new URL(allowed);
                    return originUrl.protocol === allowedUrl.protocol &&
                           originUrl.hostname === allowedUrl.hostname &&
                           originUrl.port === allowedUrl.port;
                });
            } catch {
                return false;
            }
        }

        // Fungsi Load Channel
        async function loadChannel(channelKey) {
            try {
                if (!player || !isPlayerReady) {
                    throw new Error('Player belum siap');
                }

                const channel = channels[channelKey];
                if (!channel) throw new Error('Channel tidak ditemukan');

                // Unload player sebelumnya
                await player.unload();

                // Konfigurasi DRM
                player.configure({
                    drm: {
                        clearKeys: channel.drm
                    },
                    streaming: {
                        rebufferingGoal: 1,
                        bufferingGoal: 3,
                        bufferBehind: 5,
                        autoLowLatencyMode: true,
                        lowLatencyMode: true
                    },
                    manifest: {
                        dash: {
                            ignoreMinBufferTime: true,
                            autoCorrectDrift: true
                        }
                    }
                });

                // Load channel baru
                await player.load(channel.url);
                console.log('Berhasil pindah channel:', channelKey);

            } catch (error) {
                console.error('Gagal ganti channel:', error);
                throw error;
            }
        }

        // Inisialisasi Player
        async function initPlayer() {
            try {
                const video = document.getElementById('video');
                
                // Install Shaka UI
                if (!video.ui) {
                    await shaka.ui.install(video, {
                        controlPanelElements: ['play_pause', 'time_and_duration', 'spacer', 'mute', 'volume', 'fullscreen', 'overflow_menu']
                    });
                }

                // Dapatkan referensi UI dan Player
                ui = video.ui;
                controls = ui.getControls();
                player = controls.getPlayer();

                // Event Listeners
                player.addEventListener('error', onPlayerError);
                controls.addEventListener('error', onUIError);

                // Konfigurasi UI
                ui.configure({
                    seekBarColors: {
                        base: 'rgba(255, 0, 0, 0.3)',
                        buffered: 'rgba(255, 0, 0, 0.5)',
                        played: 'red',
                        adBreaks: 'yellow'
                    }
                });

                // Ganti ikon menu
                const menuButton = document.querySelector('.shaka-overflow-menu-button');
                if (menuButton) {
                    menuButton.innerHTML = '<i class="fas fa-cog"></i>';
                }

                // Load channel awal
                const urlParams = new URLSearchParams(location.search);
                const initialChannel = urlParams.get('channel');
                if (initialChannel) await loadChannel(initialChannel);

                isPlayerReady = true;
                processPendingMessages();

            } catch (error) {
                console.error('Gagal inisialisasi player:', error);
            }
        }

        // Proses pesan tertunda
        function processPendingMessages() {
            pendingMessages.forEach(msg => {
                window.dispatchEvent(new MessageEvent('message', {
                    data: msg,
                    origin: window.location.origin
                }));
            });
            pendingMessages.length = 0;
        }

        // Penanganan Pesan
        window.addEventListener('message', async (event) => {
            if (!validateOrigin(event.origin)) {
                console.warn('Diblokir: Origin tidak diizinkan', event.origin);
                return;
            }

            if (!isPlayerReady) {
                pendingMessages.push(event.data);
                return;
            }

            try {
                if (event.data.type === 'CHANGE_CHANNEL') {
                    await loadChannel(event.data.channel);
                }
            } catch (error) {
                console.error('Error handling message:', error);
            }
        });

        // Error Handling
        function onPlayerError(error) {
            console.error('Player Error:', error.code, error);
        }

        function onUIError(error) {
            console.error('UI Error:', error.detail);
        }

        // Event Listeners Shaka
        document.addEventListener('shaka-ui-loaded', () => {
            console.log('Shaka UI Loaded');
            initPlayer().catch(console.error);
        });

        document.addEventListener('shaka-ui-load-failed', (error) => {
            console.error('Shaka UI Gagal Load:', error.detail);
        });

        // Orientation Lock
        function lockOrientation() {
            if (screen.orientation?.lock) {
                screen.orientation.lock('landscape')
                    .catch(error => console.warn('Gagal lock orientation:', error));
            }
        }

        // Fullscreen Handler
        document.addEventListener('fullscreenchange', () => {
            if (document.fullscreenElement) {
                lockOrientation();
            }
        });
    </script>
</body>
</html>

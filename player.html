<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Same head section as original -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>Video Player</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.1.1/controls.min.css" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
                html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: black;
        }
        .shaka-video-container {
            position: fixed; /* Membuat elemen tetap */
            top: 50%; /* Menempatkan elemen di tengah secara vertikal */
            left: 50%; /* Menempatkan elemen di tengah secara horizontal */
            transform: translate(-50%, -50%); /* Mengatur agar pusat elemen berada di tengah layar */
            width: 100%;
            height: 100%;
        }
        
        .shaka-video {
            width: 100%;
            height: 100%;
        }

        .shaka-play-button,
        .shaka-spinner-container {
            transform: scale(0.8); /* Ukuran ikon play dan spinner sama */
        }

        .shaka-video-container .material-icons-round {
            color: #f1ff00;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.1.1/shaka-player.ui.min.js" crossorigin="anonymous"></script>
    <!--<script disable-devtool-auto src="https://cdn.jsdelivr.net/npm/disable-devtool"></script>-->
</head>
<body>
    <!-- Same video container as original -->
    <center>
        <div data-shaka-player-container style="width: 100%; height: 100%; cursor: none;" shaka-controls="true" class="shaka-video-container">
            <video autoplay data-shaka-player id="video" style="width:100%;height:100%;" class="shaka-video" poster="/images/poster.png"></video>
            <div class="shaka-controls-container">
                <!-- Shaka Player Controls Here -->
            </div>
        </div>
    </center>
    
<script type="module">
    import channels from './channel.js';
    
    const allowedDomains = [
        'https://kltraid.pages.dev',
        'http://localhost'
    ];

    // Fungsi validasi yang lebih akurat
    function validateOrigin(origin) {
        try {
            const originUrl = new URL(origin);
            return allowedDomains.some(allowed => {
                const allowedUrl = new URL(allowed);
                return originUrl.protocol === allowedUrl.protocol &&
                       originUrl.hostname === allowedUrl.hostname &&
                       originUrl.port === allowedUrl.port;
            });
        } catch {
            return false;
        }
    }

    // Tambahkan state management
    let isPlayerReady = false;
    const pendingMessages = [];

    window.addEventListener('message', async (event) => {
        console.log('Received message from origin:', event.origin);
        console.log('Message data:', event.data);
        
        if (!validateOrigin(event.origin)) {
            console.warn(`Origin ${event.origin} not allowed`);
            return;
        }

        if (!isPlayerReady) {
            pendingMessages.push(event.data);
            return;
        }

        if (event.data.type === 'CHANGE_CHANNEL') {
            try {
                await loadChannel(event.data.channel);
            } catch (error) {
                console.error('Channel change failed:', error);
            }
        }
    });

    async function init() {
        try {
            const video = document.getElementById('video');
            if (!video.ui) {
                shaka.ui.install(video);
            }
            
            ui = video['ui'];
            player = ui.getControls().getPlayer();
            
            // Tambahkan event listener untuk readiness
            await player.isReady();
            isPlayerReady = true;
            
            // Proses pesan yang tertunda
            pendingMessages.forEach(msg => {
                window.dispatchEvent(new MessageEvent('message', {
                    data: msg,
                    origin: window.location.origin
                }));
            });
            
            console.log('Player initialized successfully');
            
        } catch (error) {
            console.error('Initialization failed:', error);
        }
    }

    // Tambahkan error handling untuk Shaka UI
    document.addEventListener('shaka-ui-loaded', () => {
        console.log('Shaka UI loaded');
        init().catch(console.error);
    });
    
    document.addEventListener('shaka-ui-load-failed', (error) => {
        console.error('Shaka UI failed to load:', error.detail);
    });
</script>
</body>
</html>

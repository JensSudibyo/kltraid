<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Player</title>
  <script src="https://yosintv.github.io/yosintv/jwcdn.js"></script>
  <script disable-devtool-auto src="https://cdn.jsdelivr.net/npm/disable-devtool"></script>
  <script type="module" src="./sources.js"></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      background-color: black;
    }

    .jw-wrapper {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
    }

    .jw-video-container {
      position: relative;
      width: 100%;
      height: 100%;
    }

    .jwplayer {
      width: 100%;
      height: auto;
      max-height: 100%;
      background-color: black;
    }

    #videoIframe {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: 0;
    }

    .hidden {
      display: none;
    }

    .loader-container {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      color: #00fa9f;
      z-index: 9999;
    }

    .loader {
      width: 48px;
      height: 48px;
      border: 5px solid #FFF;
      border-bottom-color: transparent;
      border-radius: 50%;
      display: inline-block;
      box-sizing: border-box;
      animation: rotation 1s linear infinite;
    }

    @keyframes rotation {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div id="loaderContainer" class="loader-container">
    <div class="loader"></div>
  </div>

  <div class="jw-wrapper hidden" id="jwContainer">
    <div id="player" class="jw-video-container"></div>
  </div>

  <iframe id="videoIframe" class="hidden" src="about:blank" allowfullscreen scrolling="no"
    sandbox="allow-same-origin allow-scripts allow-forms allow-pointer-lock allow-top-navigation"
    allow="encrypted-media; autoplay">
  </iframe>

  <script type="module">
    import sources from './sources.js';

    jwplayer.key = 'XSuP4qMl+9tK17QNb+4+th2Pm9AWgMO/cYH8CI0HGGr7bdjo';
    let playerInstance = null;

    function destroyJWPlayer() {
      if (playerInstance) {
        playerInstance.stop();
        playerInstance.remove();
        playerInstance = null;
        document.getElementById('jwContainer').innerHTML = '<div id="player" class="jw-video-container"></div>';
        console.log('[JW] Player destroyed');
      }
    }

    function showLoader() {
      document.getElementById('loaderContainer').classList.remove('hidden');
      document.getElementById('jwContainer').classList.add('hidden');
      const iframe = document.getElementById('videoIframe');
      iframe.src = 'about:blank';
      iframe.classList.add('hidden');
    }

    function hideLoader() {
      document.getElementById('loaderContainer').classList.add('hidden');
    }

    function setReferrerPolicy(url) {
      const blocked = ['jiatianxiazhuangshi', 'naqsheala', 'inplaynet', 'newkso', 'dens'];
      const link = document.createElement('a');
      link.href = url;
      if (blocked.some(k => link.hostname.includes(k))) {
        const meta = document.createElement('meta');
        meta.name = 'referrer';
        meta.content = 'no-referrer';
        document.head.appendChild(meta);
      }
    }

    function loadVideoByUrl(url) {
      showLoader();
      destroyJWPlayer();
      setReferrerPolicy(url);

      const iframe = document.getElementById('videoIframe');
      iframe.src = 'about:blank'; // ðŸ”‡ clear previous audio
      iframe.classList.add('hidden');

      const jwContainer = document.getElementById('jwContainer');

      if (url.includes('.m3u8')) {
        jwContainer.classList.remove('hidden');

        playerInstance = jwplayer("player").setup({
          playlist: [{
            file: url,
            image: 'https://kltraid.pages.dev/images/poster.png',
            type: "hls"
          }],
          width: "100%",
          aspectratio: "16:9",
          autostart: true,
          mute: true,
          stretching: "uniform",
          playsinline: true,
          logo: { file: '' },
          cast: {},
          sharing: false
        });

        playerInstance.on('ready', () => {
          hideLoader();
          console.log('[JW] Ready');
        });

        playerInstance.on('error', () => {
          setTimeout(() => {
            playerInstance.load({ file: url }).play();
          }, 5000);
        });

      } else if (url.startsWith('http')) {
        jwContainer.classList.add('hidden');
        iframe.src = url;
        iframe.classList.remove('hidden');

        const excluded = ['embedstreams.top', 'legalhelpfast.pro', 'streamsvv1.su'];
        const hostname = new URL(url).hostname;
        if (excluded.includes(hostname)) {
          iframe.removeAttribute('sandbox');
        }

        hideLoader();
      } else {
        console.warn('[Video] Invalid or empty source URL');
        showLoader(); // stay on loader
      }
    }

    function handlePostMessage(event) {
      const allowed = ['https://bikinbaru96.blogspot.com', 'http://localhost'];
      if (!allowed.includes(event.origin)) return;

      const { type, key, url } = event.data;

      if (type === 'SET_VIDEO' && key && sources[key]) {
        loadVideoByUrl(sources[key]);
      }

      if (type === 'CHANGE_STREAM' && url) {
        loadVideoByUrl(url);
      }
    }

    window.addEventListener('message', handlePostMessage);

    window.addEventListener('load', () => {
      window.parent.postMessage('JW_READY', '*');
      disableDevtool();
    });

    document.addEventListener('fullscreenchange', () => {
      jwplayer().setMute(true); // âœ… stay muted
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Player</title>
  <script src="https://yosintv.github.io/yosintv/jwcdn.js"></script>
  <script disable-devtool-auto src="https://cdn.jsdelivr.net/npm/disable-devtool"></script>
  <script type="text/javascript" src="//disappearsurgery.com/42/bd/bf/42bdbfa0c65f07db50603564b0771d5d.js"></script>
  <script type="module" src="./sources.js"></script>

  <style>
    html, body {
      margin: 0; padding: 0;
      width: 100%; height: 100%;
      overflow: hidden;
      background-color: black;
    }
    .jw-wrapper {
      display: flex; align-items: center; justify-content: center;
      width: 100%; height: 100%;
    }
    .jw-video-container {
      width: 100%; height: 100%;
    }
    .jwplayer {
      width: 100%; max-height: 100%;
      background-color: black;
    }
    .hidden {
      display: none;
    }
    #videoIframe {
      position: fixed; top: 0; left: 0;
      width: 100%; height: 100%;
      border: 0;
    }
    .loader-container {
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      z-index: 9999;
    }
    .loader {
      width: 48px; height: 48px;
      border: 5px solid #FFF;
      border-bottom-color: transparent;
      border-radius: 50%;
      display: inline-block;
      animation: rotation 1s linear infinite;
    }
    @keyframes rotation {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>

  <div id="loaderContainer" class="loader-container">
    <div class="loader"></div>
  </div>

  <div class="jw-wrapper hidden" id="jwContainer">
    <div id="player" class="jw-video-container"></div>
  </div>

  <iframe id="videoIframe" class="hidden" src="" frameborder="0" allowfullscreen scrolling="no"
    sandbox="allow-same-origin allow-scripts allow-forms allow-pointer-lock allow-top-navigation"
    allow="encrypted-media; autoplay">
  </iframe>

<script type="module">
  import sources from './sources.js';
  jwplayer.key = 'XSuP4qMl+9tK17QNb+4+th2Pm9AWgMO/cYH8CI0HGGr7bdjo';

  let playerInstance = null;

  function destroyJWPlayer() {
    if (playerInstance) {
      playerInstance.stop();
      playerInstance.remove();
      playerInstance = null;
      document.getElementById('jwContainer').innerHTML = '<div id="player" class="jw-video-container"></div>';
    }
  }

  function showLoader() {
    document.getElementById('loaderContainer').classList.remove('hidden');
    document.getElementById('jwContainer').classList.add('hidden');
    const iframe = document.getElementById('videoIframe');
    iframe.classList.add('hidden');
    iframe.src = 'about:blank';
  }

  function setReferrerPolicy(url) {
    const blocked = ['jiatianxiazhuangshi', 'naqsheala', 'inplaynet', 'newkso', 'op-group1-swiftservehd-1.dens'];
    const link = document.createElement('a');
    link.href = url;
    if (blocked.some(k => link.hostname.includes(k))) {
      const meta = document.createElement('meta');
      meta.name = 'referrer';
      meta.content = 'no-referrer';
      document.head.appendChild(meta);
    }
  }

  function loadVideoByUrl(url) {
    destroyJWPlayer();
    setReferrerPolicy(url);

    const iframe = document.getElementById('videoIframe');
    iframe.src = 'about:blank';
    iframe.classList.add('hidden');

    if (url.includes('.m3u8')) {
      document.getElementById('jwContainer').classList.remove('hidden');

      playerInstance = jwplayer("player").setup({
        playlist: [{
          file: url,
          image: 'https://kltraid.pages.dev/images/poster.png',
          type: "hls",
          label: "HD"
        }],
        width: "100%",
        height: "100%",
        autostart: true,
        mute: false,
        stretching: "uniform",
        playsinline: true,
        logo: { file: '' }
      });

      playerInstance.on('ready', () => {
        const container = playerInstance.getContainer();
        
        const handleOrientation = () => {
          if (screen.orientation?.type?.startsWith('portrait')) {
            screen.orientation?.lock?.('landscape').catch(console.warn);
          }
        };

        const patchFullscreenButton = () => {
          const fsBtn = container.querySelector('.jw-icon-fullscreen');
          const video = container.querySelector('.jw-video');

          if (fsBtn && video) {
            fsBtn.onclick = () => {
              if (video.requestFullscreen) {
                video.requestFullscreen()
                  .then(() => handleOrientation())
                  .catch(console.warn);
              } else if (video.webkitRequestFullscreen) {
                video.webkitRequestFullscreen();
                setTimeout(handleOrientation, 300);
              }
            };
          }
        };

        const checkFullscreenButton = setInterval(() => {
          if (container.querySelector('.jw-icon-fullscreen')) {
            patchFullscreenButton();
            clearInterval(checkFullscreenButton);
          }
        }, 300);
      });

      playerInstance.addButton(
        `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="white" viewBox="0 0 16 16">
          <path d="M8 3a5 5 0 1 1-4.546 2.914.5.5 0 0 0-.908-.418A6 6 0 1 0 8 2v1z"/>
          <path d="M8 0a.5.5 0 0 1 .5.5v3.793l1.146-1.147a.5.5 0 0 1 .708.708l-2 2a.5.5 0 0 1-.708 0l-2-2a.5.5 0 1 1 .708-.708L7.5 4.293V.5A.5.5 0 0 1 8 0z"/>
        </svg>`,
        "Refresh Video",
        () => playerInstance.load({ file: url }).play(),
        "refresh-button"
      );

    } else {
      iframe.src = url;
      iframe.classList.remove('hidden');
      
      // Handle orientation untuk iframe
      iframe.onload = () => {
        try {
          iframe.contentWindow.postMessage('FORCE_LANDSCAPE', '*');
        } catch(e) {}
      };
    }

    document.getElementById('loaderContainer').classList.add('hidden');
  }

  // Handle orientation change untuk semua tipe player
  function onFullscreenChange() {
    const elem = document.fullscreenElement || document.webkitFullscreenElement;
    if (elem) {
      if (screen.orientation?.lock) {
        screen.orientation.lock('landscape').catch(() => {
          setTimeout(() => screen.orientation?.lock?.('landscape'), 300);
        });
      }
    } else {
      screen.orientation?.unlock?.();
    }
  }

  document.addEventListener('fullscreenchange', onFullscreenChange);
  document.addEventListener('webkitfullscreenchange', onFullscreenChange);

  // Handle message untuk iframe
  window.addEventListener('message', (e) => {
    if (e.data === 'REQUEST_ORIENTATION_LOCK') {
      screen.orientation?.lock?.('landscape').catch(console.warn);
    }
  });
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>JWPlayer Iframe</title>
  <script src="https://content.jwplatform.com/libraries/SAHhwvZq.js"></script>
  <script disable-devtool-auto src="https://cdn.jsdelivr.net/npm/disable-devtool"></script>
  <style>
    html, body {
      margin: 0; padding: 0;
      width: 100%; height: 100%;
      background-color: black;
      overflow: hidden;
    }
    .jwplayer {
      width: 100% !important;
      height: 100% !important;
    }
    .loader-container {
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      z-index: 9999;
    }
    .loader {
      width: 48px; height: 48px;
      border: 5px solid #FFF;
      border-bottom-color: transparent;
      border-radius: 50%;
      animation: rotation 1s linear infinite;
    }
    @keyframes rotation {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>

<div class="loader-container" id="loaderContainer">
  <div class="loader"></div>
</div>

<div id="player" class="jw-video-container"></div>

<script type="module">
  import sources from './sources.js';
  jwplayer.key = 'XSuP4qMl+9tK17QNb+4+th2Pm9AWgMO/cYH8CI0HGGr7bdjo';

  let playerInstance = null;

  function requestLandscapeOrientation() {
    if (screen.orientation?.lock) {
      screen.orientation.lock('landscape').catch(err => {
        console.warn('[Orientation] Lock failed:', err);
      });
    }
  }

  function onFullscreenChange() {
    const isFS = document.fullscreenElement || document.webkitFullscreenElement;
    if (isFS) requestLandscapeOrientation();
  }

  // Global fullscreen orientation lock
  document.addEventListener('fullscreenchange', onFullscreenChange);
  document.addEventListener('webkitfullscreenchange', onFullscreenChange);

  function loadJWVideo(url) {
    const container = document.getElementById('player');
    document.getElementById('loaderContainer').style.display = 'none';

    playerInstance = jwplayer("player").setup({
      playlist: [{
        file: url,
        image: 'https://kltraid.pages.dev/images/poster.png',
        type: "hls",
        label: "HD"
      }],
      width: "100%",
      aspectratio: "16:9",
      autostart: true,
      mute: false,
      stretching: "uniform",
      playsinline: true,
      logo: { file: '' },
      cast: {},
      sharing: false
    });

    playerInstance.addButton(
      `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="white" stroke="white" stroke-width="0.8" viewBox="0 0 16 16">
        <path fill-rule="evenodd" d="M8 3a5 5 0 1 1-4.546 2.914.5.5 0 1 0-.908-.418A6 6 0 1 0 8 2v1z"/>
        <path d="M8 0a.5.5 0 0 1 .5.5v3.793l1.146-1.147a.5.5 0 0 1 .708.708l-2 2a.5.5 0 0 1-.708 0l-2-2a.5.5 0 1 1 .708-.708L7.5 4.293V.5A.5.5 0 0 1 8 0z"/>
      </svg>`,
      "Refresh Video",
      () => {
        const currentFile = playerInstance.getPlaylistItem().file;
        playerInstance.stop().load({ file: currentFile }).play();
      },
      "refresh-button"
    );

    playerInstance.on('error', () => {
      setTimeout(() => {
        playerInstance.stop().load({ file: url }).play();
      }, 5000);
    });
  }

  function handlePostMessage(event) {
    const { type, key, url } = event.data;

    if (type === 'SET_VIDEO' && key && sources[key]) {
      loadJWVideo(sources[key]);
    }

    if (type === 'CHANGE_STREAM' && url) {
      loadJWVideo(url);
    }
  }

  window.addEventListener('message', handlePostMessage);
  window.addEventListener('load', () => {
    window.parent.postMessage('JW_READY', '*');
    disableDevtool();
  });
</script>

</body>
</html>
